<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Tic-Tac-Toe - Client State</title>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import ui from "/ui.js";

    const checkWinner = (board) => {
      const lines = [
        [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
        [0, 3, 6], [1, 4, 7], [2, 5, 8], // cols
        [0, 4, 8], [2, 4, 6]             // diagonals
      ];
      for (const [a, b, c] of lines) {
        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
          return { winner: board[a], line: [a, b, c] };
        }
      }
      if (board.every(cell => cell)) return { winner: 'draw' };
      return null;
    };

    ui.app("10.10 Tic-Tac-Toe")
      .blurb("Classic game with win detection and score tracking. Pure client-side state.")

      .section("Game")
        .id("board")
        .query({
          board: Array(9).fill(null),
          turn: 'X',
          winner: null,
          winLine: null,
          scores: { X: 0, O: 0, draws: 0 }
        })
        .customView(({ store }) => {
          const board = store.board || Array(9).fill(null);
          const turn = store.turn || 'X';
          const winner = store.winner || null;
          const winLine = store.winLine || null;

          const status = winner
            ? winner === 'draw'
              ? "It's a draw!"
              : `${winner} wins!`
            : `${turn}'s turn`;

          return `
            <div class="text-center mb-6">
              <div class="text-2xl font-bold ${winner && winner !== 'draw' ? 'text-green-600' : ''}">${status}</div>
            </div>
            <div class="grid grid-cols-3 gap-2 max-w-xs mx-auto mb-6">
              ${board.map((cell, i) => {
                const isWinCell = winLine?.includes(i);
                return `
                  <button class="cell aspect-square text-4xl font-bold rounded-lg border-2 transition-all
                    ${cell ? 'cursor-not-allowed' : 'hover:bg-slate-100 cursor-pointer'}
                    ${isWinCell ? 'bg-green-100 border-green-500' : 'border-slate-200'}
                    ${cell === 'X' ? 'text-blue-600' : 'text-red-600'}"
                    data-index="${i}" ${cell || winner ? 'disabled' : ''}>
                    ${cell || ''}
                  </button>
                `;
              }).join('')}
            </div>
          `;
        })
        .onRender(({ store, element }) => {
          element.querySelectorAll('.cell').forEach(cell => {
            cell.addEventListener('click', () => {
              // Initialize board state if needed
              if (!store.board) {
                store.board = Array(9).fill(null);
                store.turn = 'X';
                store.winner = null;
              }
              // Don't return here - continue with placing the move
              const i = parseInt(cell.dataset.index);
              if (store.board[i] || store.winner) return;

              const newBoard = [...store.board];
              newBoard[i] = store.turn;
              store.board = newBoard;

              const result = checkWinner(newBoard);
              if (result) {
                store.winner = result.winner;
                store.winLine = result.line || null;
                if (result.winner === 'draw') {
                  store.scores.draws++;
                } else {
                  store.scores[result.winner]++;
                }
                store.scores = { ...store.scores };
              } else {
                store.turn = store.turn === 'X' ? 'O' : 'X';
              }

              window.dispatchEvent(new CustomEvent('ui:refresh:board'));
              window.dispatchEvent(new CustomEvent('ui:refresh:scores'));
            });
          });
        })
        .action("New Game")
          .local()
          .set({
            board: [null, null, null, null, null, null, null, null, null],
            turn: 'X',
            winner: null,
            winLine: null
          })
          .refreshAll()
          .end()
        .end()

      .section("Scoreboard")
        .id("scores")
        .query({ scores: { X: 0, O: 0, draws: 0 } })
        .kpis([
          { label: "X Wins", compute: (d, store) => store.scores?.X || 0 },
          { label: "O Wins", compute: (d, store) => store.scores?.O || 0 },
          { label: "Draws", compute: (d, store) => store.scores?.draws || 0 }
        ])
        .action("Reset Scores")
          .local()
          .set({ scores: { X: 0, O: 0, draws: 0 } })
          .refreshAll()
          .end()
        .end()

      .mount();
  </script>
</body>
</html>
