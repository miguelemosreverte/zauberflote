<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Shopping Cart - Client State</title>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import ui from "/ui.js";

    const products = [
      { id: 1, name: "Laptop", price: 999 },
      { id: 2, name: "Mouse", price: 29 },
      { id: 3, name: "Keyboard", price: 79 },
      { id: 4, name: "Monitor", price: 349 },
      { id: 5, name: "Headphones", price: 149 }
    ];

    ui.app("10.2 Shopping Cart")
      .blurb("Add items to cart, adjust quantities, see totals. Pure client-side state.")

      .section("Store")
        .id("store")
        .query({ products: products, cart: [] })
        .customView(({ store }) => {
          // Initialize store with products if not already set
          if (!store.products || store.products.length === 0) {
            store.products = products;
          }
          if (!store.cart) {
            store.cart = [];
          }
          const cart = store.cart;
          const productList = store.products;
          const totalItems = cart.reduce((sum, i) => sum + i.qty, 0);
          const totalPrice = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);

          return `
            <div class="grid md:grid-cols-2 gap-6">
              <!-- Products -->
              <div>
                <h3 class="font-semibold text-lg mb-3">Available Products</h3>
                <div class="space-y-2">
                  ${productList.map(p => `
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                      <div>
                        <div class="font-medium">${p.name}</div>
                        <div class="text-sm text-slate-500">$${p.price}</div>
                      </div>
                      <button class="add-btn px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600" data-id="${p.id}">
                        Add to Cart
                      </button>
                    </div>
                  `).join('')}
                </div>
              </div>

              <!-- Cart -->
              <div>
                <h3 class="font-semibold text-lg mb-3">Shopping Cart</h3>
                ${cart.length === 0
                  ? '<div class="text-slate-400 text-center py-8">Your cart is empty</div>'
                  : `
                    <div class="space-y-2 mb-4">
                      ${cart.map(item => `
                        <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                          <div class="flex-1">
                            <div class="font-medium">${item.name}</div>
                            <div class="text-sm text-slate-500">$${item.price} × ${item.qty} = $${item.price * item.qty}</div>
                          </div>
                          <div class="flex items-center gap-2">
                            <button class="qty-btn w-8 h-8 bg-slate-200 rounded hover:bg-slate-300" data-action="dec" data-id="${item.id}">-</button>
                            <span class="w-8 text-center font-medium">${item.qty}</span>
                            <button class="qty-btn w-8 h-8 bg-slate-200 rounded hover:bg-slate-300" data-action="inc" data-id="${item.id}">+</button>
                            <button class="remove-btn ml-2 px-2 py-1 text-red-500 text-sm hover:bg-red-50 rounded" data-id="${item.id}">✕</button>
                          </div>
                        </div>
                      `).join('')}
                    </div>

                    <!-- Summary -->
                    <div class="border-t pt-4">
                      <div class="flex justify-between text-lg font-semibold">
                        <span>Total (${totalItems} items)</span>
                        <span>$${totalPrice}</span>
                      </div>
                      <button class="clear-btn mt-3 w-full py-2 bg-red-100 text-red-600 rounded hover:bg-red-200">
                        Clear Cart
                      </button>
                    </div>
                  `
                }
              </div>
            </div>
          `;
        })
        .onRender(({ store, element }) => {
          // Add to cart
          element.querySelectorAll('.add-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const id = parseInt(btn.dataset.id);
              const product = store.products.find(p => p.id === id);
              if (!product) return;

              const existing = store.cart.find(i => i.id === id);
              if (existing) {
                existing.qty += 1;
              } else {
                store.cart.push({ ...product, qty: 1 });
              }
              store.cart = [...store.cart];
              window.dispatchEvent(new CustomEvent('ui:refresh:store'));
            });
          });

          // Quantity buttons
          element.querySelectorAll('.qty-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const id = parseInt(btn.dataset.id);
              const action = btn.dataset.action;
              const item = store.cart.find(i => i.id === id);
              if (!item) return;

              if (action === 'inc') {
                item.qty += 1;
              } else if (action === 'dec' && item.qty > 1) {
                item.qty -= 1;
              }
              store.cart = [...store.cart];
              window.dispatchEvent(new CustomEvent('ui:refresh:store'));
            });
          });

          // Remove item
          element.querySelectorAll('.remove-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const id = parseInt(btn.dataset.id);
              store.cart = store.cart.filter(i => i.id !== id);
              window.dispatchEvent(new CustomEvent('ui:refresh:store'));
            });
          });

          // Clear cart
          const clearBtn = element.querySelector('.clear-btn');
          if (clearBtn) {
            clearBtn.addEventListener('click', () => {
              store.cart = [];
              window.dispatchEvent(new CustomEvent('ui:refresh:store'));
            });
          }
        })
        .end()

      .mount();
  </script>
</body>
</html>
