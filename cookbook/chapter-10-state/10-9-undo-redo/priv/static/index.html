<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Undo/Redo - Client State</title>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import ui from "/ui.js";

    ui.app("10.9 Undo/Redo")
      .blurb("State history with undo/redo. Every action is recorded and reversible.")

      .section("Drawing Canvas")
        .id("canvas")
        .query({
          shapes: [],
          history: ['[]'],
          historyIndex: 0,
          nextId: 1
        })
        .customView(({ store }) => {
          const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6'];

          // Ensure arrays are properly initialized
          const shapes = store.shapes || [];
          const history = store.history || ['[]'];
          const historyIndex = store.historyIndex || 0;

          const canUndo = historyIndex > 0;
          const canRedo = historyIndex < history.length - 1;

          return `
            <!-- Color Palette -->
            <div class="mb-4">
              <div class="text-sm font-medium mb-2">Add Shape (click a color)</div>
              <div class="flex gap-2">
                ${colors.map(c => `
                  <button class="add-shape w-10 h-10 rounded-lg shadow-md hover:scale-110 transition-transform cursor-pointer"
                    style="background: ${c}" data-color="${c}"></button>
                `).join('')}
              </div>
            </div>

            <!-- Canvas -->
            <div class="bg-slate-100 rounded-lg p-4 min-h-[200px] flex flex-wrap gap-2 content-start mb-4">
              ${shapes.length === 0
                ? '<div class="text-slate-400 w-full text-center py-12">Click a color above to add shapes. Click shapes to remove them.</div>'
                : shapes.map(s => `
                    <div class="shape w-12 h-12 rounded-lg cursor-pointer hover:scale-110 hover:rotate-12 transition-all shadow-md"
                      style="background: ${s.color}" data-id="${s.id}" title="Click to remove"></div>
                  `).join('')
              }
            </div>

            <!-- Controls -->
            <div class="flex gap-3 mb-4">
              <button class="undo-btn px-4 py-2 rounded border flex items-center gap-2 ${canUndo ? 'border-slate-300 hover:bg-slate-100' : 'border-slate-200 text-slate-300 cursor-not-allowed'}">
                <span>↩</span> Undo
              </button>
              <button class="redo-btn px-4 py-2 rounded border flex items-center gap-2 ${canRedo ? 'border-slate-300 hover:bg-slate-100' : 'border-slate-200 text-slate-300 cursor-not-allowed'}">
                <span>↪</span> Redo
              </button>
              <button class="clear-btn px-4 py-2 rounded border border-red-300 text-red-600 hover:bg-red-50 ml-auto">
                Clear All
              </button>
            </div>

            <!-- History Stack -->
            <div class="border-t pt-4">
              <div class="text-sm font-medium mb-2">History Stack</div>
              ${history.length === 0
                ? '<div class="text-slate-400 text-sm">No history yet</div>'
                : `
                  <div class="flex gap-2 overflow-x-auto pb-2">
                    ${history.map((h, i) => {
                      const historyShapes = JSON.parse(h);
                      return `
                        <div class="flex-shrink-0 w-16 h-16 rounded border-2 p-1 flex flex-wrap gap-0.5 content-start ${
                          i === historyIndex ? 'border-slate-900 bg-slate-50' : 'border-slate-200'
                        }">
                          ${historyShapes.slice(0, 9).map(s => `
                            <div class="w-3 h-3 rounded-sm" style="background: ${s.color}"></div>
                          `).join('')}
                          ${historyShapes.length > 9 ? `<div class="text-xs text-slate-400">+${historyShapes.length - 9}</div>` : ''}
                          ${historyShapes.length === 0 ? '<div class="text-xs text-slate-300 w-full text-center mt-4">empty</div>' : ''}
                        </div>
                      `;
                    }).join('')}
                  </div>
                  <div class="text-xs text-slate-500 mt-2">
                    Position: ${historyIndex + 1} / ${history.length}
                  </div>
                `
              }
            </div>
          `;
        })
        .onRender(({ store, element }) => {
          // Ensure arrays are always initialized
          if (!Array.isArray(store.shapes)) store.shapes = [];
          if (!Array.isArray(store.history)) store.history = ['[]'];

          const saveHistory = () => {
            // Truncate any redo history
            const currentHistory = Array.isArray(store.history) ? store.history : ['[]'];
            store.history = currentHistory.slice(0, (store.historyIndex || 0) + 1);
            // Save current state
            const currentShapes = Array.isArray(store.shapes) ? store.shapes : [];
            store.history.push(JSON.stringify(currentShapes));
            store.historyIndex = store.history.length - 1;
          };

          // Add shape
          element.querySelectorAll('.add-shape').forEach(btn => {
            btn.addEventListener('click', () => {
              const currentShapes = Array.isArray(store.shapes) ? store.shapes : [];
              store.shapes = [...currentShapes, { id: store.nextId || 1, color: btn.dataset.color }];
              store.nextId = (store.nextId || 1) + 1;
              saveHistory();
              window.dispatchEvent(new CustomEvent('ui:refresh:canvas'));
            });
          });

          // Remove shape
          element.querySelectorAll('.shape').forEach(shape => {
            shape.addEventListener('click', () => {
              const id = parseInt(shape.dataset.id);
              const currentShapes = Array.isArray(store.shapes) ? store.shapes : [];
              store.shapes = currentShapes.filter(s => s.id !== id);
              saveHistory();
              window.dispatchEvent(new CustomEvent('ui:refresh:canvas'));
            });
          });

          // Undo
          const undoBtn = element.querySelector('.undo-btn');
          if (undoBtn) {
            undoBtn.addEventListener('click', () => {
              if (store.historyIndex > 0) {
                store.historyIndex--;
                store.shapes = JSON.parse(store.history[store.historyIndex]);
                window.dispatchEvent(new CustomEvent('ui:refresh:canvas'));
              }
            });
          }

          // Redo
          const redoBtn = element.querySelector('.redo-btn');
          if (redoBtn) {
            redoBtn.addEventListener('click', () => {
              if (store.historyIndex < store.history.length - 1) {
                store.historyIndex++;
                store.shapes = JSON.parse(store.history[store.historyIndex]);
                window.dispatchEvent(new CustomEvent('ui:refresh:canvas'));
              }
            });
          }

          // Clear
          const clearBtn = element.querySelector('.clear-btn');
          if (clearBtn) {
            clearBtn.addEventListener('click', () => {
              store.shapes = [];
              store.history = ['[]'];
              store.historyIndex = 0;
              window.dispatchEvent(new CustomEvent('ui:refresh:canvas'));
            });
          }
        })
        .end()

      .mount();
  </script>
</body>
</html>
