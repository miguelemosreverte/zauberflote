<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Registration Wizard</title>
  <style>
    .step-content { display: none; }
    .step-content.active { display: block; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import ui from "/ui.js";

    ui.app("Join Zauberflote")
      .blurb("A multi-step registration process with state-driven transitions.")
      .section("Onboarding Wizard")
        .id("wizard")
        .customView(({ store }) => {
          const step = store.wizard_step || 1;
          const email = store.wizard_email || "";

          if (step === 4) return `<div class='text-center py-10'><h2 class='text-2xl font-bold text-emerald-600'>ðŸŽ‰ Success!</h2><p class='text-slate-500'>Your account is ready.</p></div>`;

          return `
            <div class="space-y-6">
              <!-- Progress Bar -->
              <div class="flex justify-between mb-8">
                ${[1,2,3].map(s => `
                  <div class="flex flex-col items-center flex-1">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center ${step >= s ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-400'} font-bold text-xs mb-1">${s}</div>
                    <span class="text-[10px] uppercase font-bold tracking-tighter ${step >= s ? 'text-indigo-600' : 'text-slate-400'}">${s===1?'Info':s===2?'Plan':'Final'}</span>
                  </div>
                `).join('<div class="h-px bg-slate-200 flex-1 mt-4"></div>')}
              </div>

              <!-- Step 1 -->
              <div class="step-content ${step === 1 ? 'active' : ''}">
                <h3 class="font-bold mb-4">Step 1: Your Profile</h3>
                <div class="space-y-3">
                  <input id="wiz_email" type="email" placeholder="Email" class="w-full border rounded p-2" value="${email}">
                  <input id="wiz_name" type="text" placeholder="Full Name" class="w-full border rounded p-2">
                  <button onclick="submitStep1()" class="w-full bg-indigo-600 text-white p-2 rounded font-bold">Continue to Plan</button>
                </div>
              </div>

              <!-- Step 2 -->
              <div class="step-content ${step === 2 ? 'active' : ''}">
                <h3 class="font-bold mb-4">Step 2: Choose a Plan</h3>
                <div class="grid grid-cols-2 gap-4">
                  <div onclick="submitStep2('FREE')" class="border rounded p-4 cursor-pointer hover:border-indigo-600 transition-all">
                    <div class="font-bold">Free</div>
                    <div class="text-xs text-slate-500">Basic features</div>
                  </div>
                  <div onclick="submitStep2('PRO')" class="border rounded p-4 cursor-pointer hover:border-indigo-600 transition-all">
                    <div class="font-bold text-indigo-600">Pro</div>
                    <div class="text-xs text-slate-500">$10/month</div>
                  </div>
                </div>
              </div>

              <!-- Step 3 -->
              <div class="step-content ${step === 3 ? 'active' : ''}">
                <h3 class="font-bold mb-4">Step 3: Confirmation</h3>
                <p class="text-sm text-slate-600 mb-6">You're almost there! Click finish to activate your account.</p>
                <button onclick="completeWizard()" class="w-full bg-slate-900 text-white p-3 rounded-xl font-bold">Finish Setup</button>
              </div>
            </div>
          `;
        })
        .onRender(({ store }) => {
          // Global handlers for the wizard
          window.submitStep1 = async () => {
            const email = document.getElementById('wiz_email').value;
            const fullname = document.getElementById('wiz_name').value;
            const res = await fetch('/register/step1', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ email, fullname })
            });
            if (res.ok) {
              store.wizard_email = email;
              store.wizard_step = 2;
              window.dispatchEvent(new CustomEvent('ui:refresh:wizard'));
            }
          };

          window.submitStep2 = async (plan) => {
            const res = await fetch('/register/step2', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ email: store.wizard_email, plan })
            });
            if (res.ok) {
              store.wizard_step = 3;
              window.dispatchEvent(new CustomEvent('ui:refresh:wizard'));
            }
          };

          window.completeWizard = async () => {
            const res = await fetch('/register/complete', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ email: store.wizard_email })
            });
            if (res.ok) {
              store.wizard_step = 4;
              window.dispatchEvent(new CustomEvent('ui:refresh:wizard'));
            }
          };
        })
        .end()
      .mount();
  </script>
</body>
</html>
