<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Approval Workflow</title>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import ui from "/ui.js";

    ui.app("Approval State Machine")
      .blurb("Multi-persona workflow demonstrating status-based conditional actions.")
      .section("Employee: Create Invoice")
        .action("Submit Invoice").post("/invoices")
          .field("amount", 100, "number")
          .field("description", "Office supplies")
          .refreshAll()
          .end()
        .end()
      .group("Personas")
        .grid(2)
        .section("Manager: Pending Approval")
          .read("/invoices")
          .customView(({ data }) => {
            const pending = (data || []).filter(i => i.status === 'PENDING_MANAGER');
            if (pending.length === 0) return "<p class='text-xs text-slate-400'>No invoices pending your approval.</p>";
            return pending.map(i => `
              <div class="p-3 border rounded mb-2 bg-slate-50 flex justify-between items-center">
                <span class="text-sm font-medium">${i.description} ($${i.amount})</span>
                <div class="flex gap-2">
                  <button onclick="approve(${i.id})" class="bg-emerald-600 text-white px-2 py-1 rounded text-xs">Approve</button>
                  <button onclick="reject(${i.id})" class="bg-rose-600 text-white px-2 py-1 rounded text-xs">Reject</button>
                </div>
              </div>
            `).join('');
          })
          .onRender(() => {
            // Global helper functions for the custom buttons
            window.approve = async (id) => {
              await fetch(`/invoices/${id}/approve-manager`, { method: 'POST' });
              window.dispatchEvent(new CustomEvent('ui:refresh:all'));
            };
            window.reject = async (id) => {
              await fetch(`/invoices/${id}/reject`, { method: 'POST' });
              window.dispatchEvent(new CustomEvent('ui:refresh:all'));
            };
          })
          .end()
        .section("Accountant: Payment Queue")
          .read("/invoices")
          .customView(({ data }) => {
            const pending = (data || []).filter(i => i.status === 'PENDING_ACCOUNTANT');
            if (pending.length === 0) return "<p class='text-xs text-slate-400'>No invoices ready for payment.</p>";
            return pending.map(i => `
              <div class="p-3 border rounded mb-2 bg-slate-50 flex justify-between items-center">
                <span class="text-sm font-medium">${i.description} ($${i.amount})</span>
                <button onclick="pay(${i.id})" class="bg-sky-600 text-white px-2 py-1 rounded text-xs">Pay Now</button>
              </div>
            `).join('');
          })
          .onRender(() => {
            window.pay = async (id) => {
              await fetch(`/invoices/${id}/pay`, { method: 'POST' });
              window.dispatchEvent(new CustomEvent('ui:refresh:all'));
            };
          })
          .end()
        .end()
      .section("Invoice Tracking (All)")
        .read("/invoices")
        .list("{{description}}: ${{amount}} - <span class='font-bold'>{{status}}</span>")
        .end()
      .mount();

    // Listen for refresh all event
    window.addEventListener('ui:refresh:all', () => {
       document.querySelectorAll('section').forEach(s => {
         if (s.__builder && s.__builder.refresh) s.__builder.refresh();
       });
    });
  </script>
</body>
</html>
