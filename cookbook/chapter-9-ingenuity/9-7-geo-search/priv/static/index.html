<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <title>Geo Search</title>
  <style>
    #map { height: 400px; border-radius: 0.5rem; }
    .leaflet-popup-content { margin: 8px 12px; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import ui from "/ui.js";

    let map = null;
    let markers = [];

    ui.app("Geo Search")
      .blurb("Interactive map-based location search with Leaflet.js integration.")
      .section("Add Location")
        .action("Add Location").post("/locations")
          .field("name", "New Location")
          .field("description", "Description here")
          .field("lat", 40.7128)
          .field("lng", -74.0060)
          .field("category", "place")
          .refreshAll()
          .end()
        .end()
      .section("World Map")
        .id("map-view")
        .read("/locations")
        .mock(() => [
          { id: 1, name: 'San Francisco', description: 'Tech hub of the West Coast', lat: 37.7749, lng: -122.4194, category: 'city' },
          { id: 2, name: 'New York', description: 'Financial and tech center', lat: 40.7128, lng: -74.0060, category: 'city' },
          { id: 3, name: 'London', description: 'European tech hub', lat: 51.5074, lng: -0.1278, category: 'city' },
          { id: 4, name: 'Tokyo', description: 'Asian tech center', lat: 35.6762, lng: 139.6503, category: 'city' },
          { id: 5, name: 'Berlin', description: 'European startup scene', lat: 52.5200, lng: 13.4050, category: 'city' }
        ])
        .customView(({ data }) => {
          return `<div class="bg-white rounded-xl shadow-sm border p-4">
            <div id="map"></div>
            <div class="mt-4 flex gap-2">
              <input type="text" id="search-input" placeholder="Search locations..."
                     class="flex-1 px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" />
              <button onclick="window.searchLocations()"
                      class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm hover:bg-emerald-700 transition-colors">
                Search
              </button>
            </div>
            <div id="search-results" class="mt-3"></div>
          </div>`;
        })
        .onRender(({ data, element }) => {
          // Initialize map if not exists
          if (!map) {
            map = L.map('map').setView([30, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
          }

          // Clear existing markers
          markers.forEach(m => map.removeLayer(m));
          markers = [];

          // Add markers for each location
          (data || []).forEach(loc => {
            const marker = L.marker([loc.lat, loc.lng])
              .addTo(map)
              .bindPopup(`
                <div class="font-sans">
                  <strong class="text-emerald-700">${loc.name}</strong>
                  <p class="text-sm text-gray-600 mt-1">${loc.description || ''}</p>
                  <span class="inline-block mt-2 px-2 py-0.5 bg-slate-100 text-slate-600 rounded text-xs">${loc.category}</span>
                </div>
              `);
            markers.push(marker);
          });

          // Fit bounds if we have markers
          if (markers.length > 0) {
            const group = L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
          }

          // Search function
          window.searchLocations = async () => {
            const query = document.getElementById('search-input').value;
            const resultsDiv = document.getElementById('search-results');

            if (!query) {
              resultsDiv.innerHTML = '';
              return;
            }

            try {
              const res = await fetch(`/search?q=${encodeURIComponent(query)}`);
              const json = await res.json();
              const results = json.data || [];

              if (results.length === 0) {
                resultsDiv.innerHTML = '<p class="text-sm text-slate-500">No locations found</p>';
                return;
              }

              resultsDiv.innerHTML = results.map(loc => `
                <div class="p-2 hover:bg-slate-50 rounded cursor-pointer flex justify-between items-center"
                     onclick="window.focusLocation(${loc.lat}, ${loc.lng})">
                  <div>
                    <span class="font-medium text-slate-700">${loc.name}</span>
                    <span class="text-xs text-slate-400 ml-2">${loc.category}</span>
                  </div>
                  <span class="text-xs text-slate-500">${loc.lat.toFixed(2)}, ${loc.lng.toFixed(2)}</span>
                </div>
              `).join('');
            } catch (e) {
              resultsDiv.innerHTML = '<p class="text-sm text-red-500">Search failed</p>';
            }
          };

          window.focusLocation = (lat, lng) => {
            map.setView([lat, lng], 8);
            // Find and open the marker popup
            markers.forEach(m => {
              const pos = m.getLatLng();
              if (Math.abs(pos.lat - lat) < 0.001 && Math.abs(pos.lng - lng) < 0.001) {
                m.openPopup();
              }
            });
          };

          // Search on Enter key
          document.getElementById('search-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') window.searchLocations();
          });
        })
        .end()
      .section("All Locations")
        .read("/locations")
        .mock(() => [
          { id: 1, name: 'San Francisco', lat: 37.77, lng: -122.42, category: 'city' },
          { id: 2, name: 'New York', lat: 40.71, lng: -74.01, category: 'city' },
          { id: 3, name: 'London', lat: 51.51, lng: -0.13, category: 'city' }
        ])
        .template("table")
        .end()
      .mount();
  </script>
</body>
</html>
